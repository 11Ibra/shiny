<!DOCTYPE html>
<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style type="text/css">
body {
  overflow: hidden;
}
button {
  font-size: 18px;
}
svg {
  border: 1px solid silver;
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
  z-index: -1;
}
.node text {
  font-family: 'Source Code Pro', monospace;
  text-anchor: start;
  fill: #999;
  transform: scale(0.3);
}
.node.running text {
  fill: black;
}
.node text tspan {
  white-space: pre;
}
.node path {
  z-index: 1;
  fill: white;
  stroke: #777;
  stroke-width: 7.5px;
  transition: stroke 0.75s ease;
}
.node.observer path {
}
.node.observable path {
}
.node.value path {
}
.node.invalidated path {
  fill: #E0E0E0;
  /*fill: url(#diagonalHatch);*/
}
.node.running path {
  fill: #61B97E;
}
#triangle {
  fill: #CCC;
}
.link {
  fill: none;
  stroke: #CCC;
  stroke-width: 0.5px;
  z-index: 0;
}
#description {
  position: fixed;
  width: 300px;
  left: 630px;
  top: 36px;
  height: auto;
}
</style>
<script>
var log = [
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$dataset"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$caption"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$obs"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_caption_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_summary_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_view_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$pixelratio"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_protocol"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_hostname"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_port"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_pathname"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_search"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_hash_initial"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$allowDataUriScheme"
  },
  {
    "action" : "ctx",
    "id" : "1",
    "label" : "output$caption",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "1"
  },
  {
    "action" : "ctx",
    "id" : "2",
    "label" : "output$summary",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "2"
  },
  {
    "action" : "ctx",
    "id" : "3",
    "label" : "output$view",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "3"
  },
  {
    "action" : "ctx",
    "id" : "4",
    "label" : "output$caption",
    "type" : "observer",
    "prevId" : "1"
  },
  {
    "action" : "enter",
    "id" : "4"
  },
  {
    "action" : "dep",
    "id" : "4",
    "dependsOn" : "input$caption"
  },
  {
    "action" : "exit",
    "id" : "4"
  },
  {
    "action" : "ctx",
    "id" : "5",
    "label" : "output$summary",
    "type" : "observer",
    "prevId" : "2"
  },
  {
    "action" : "enter",
    "id" : "5"
  },
  {
    "action" : "ctx",
    "id" : "6",
    "label" : "reactive({\n    switch(input$dataset,\n           rock = rock,\n           pressure = pressure,\n           cars = cars)\n})",
    "type" : "observable",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "6"
  },
  {
    "action" : "dep",
    "id" : "6",
    "dependsOn" : "input$dataset"
  },
  {
    "action" : "exit",
    "id" : "6"
  },
  {
    "action" : "depId",
    "id" : "5",
    "dependsOn" : "6"
  },
  {
    "action" : "exit",
    "id" : "5"
  },
  {
    "action" : "ctx",
    "id" : "7",
    "label" : "output$view",
    "type" : "observer",
    "prevId" : "3"
  },
  {
    "action" : "enter",
    "id" : "7"
  },
  {
    "action" : "depId",
    "id" : "7",
    "dependsOn" : "6"
  },
  {
    "action" : "dep",
    "id" : "7",
    "dependsOn" : "input$obs"
  },
  {
    "action" : "exit",
    "id" : "7"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$dataset"
  },
  {
    "action" : "invalidate",
    "id" : "6"
  },
  {
    "action" : "invalidate",
    "id" : "5"
  },
  {
    "action" : "invalidate",
    "id" : "7"
  },
  {
    "action" : "ctx",
    "id" : "8",
    "label" : "output$summary",
    "type" : "observer",
    "prevId" : "5"
  },
  {
    "action" : "enter",
    "id" : "8"
  },
  {
    "action" : "ctx",
    "id" : "9",
    "label" : "reactive({\n    switch(input$dataset, rock = rock, pressure = pressure, cars = cars)\n})",
    "type" : "observable",
    "prevId" : "6"
  },
  {
    "action" : "enter",
    "id" : "9"
  },
  {
    "action" : "dep",
    "id" : "9",
    "dependsOn" : "input$dataset"
  },
  {
    "action" : "exit",
    "id" : "9"
  },
  {
    "action" : "depId",
    "id" : "8",
    "dependsOn" : "9"
  },
  {
    "action" : "exit",
    "id" : "8"
  },
  {
    "action" : "ctx",
    "id" : "10",
    "label" : "output$view",
    "type" : "observer",
    "prevId" : "7"
  },
  {
    "action" : "enter",
    "id" : "10"
  },
  {
    "action" : "depId",
    "id" : "10",
    "dependsOn" : "9"
  },
  {
    "action" : "dep",
    "id" : "10",
    "dependsOn" : "input$obs"
  },
  {
    "action" : "exit",
    "id" : "10"
  }
];
try {
  log = __DATA__;
} catch (e) {}

var nodes = {};
var nodeList = [];
var nodeSelection = null;
var links = [];
var linkSelection = null;

var node, link;  // d3 selections

var force = d3.layout.force()
    .charge(-100)
    .nodes(nodeList)
    .links(links);
force.on('tick', onTick);

function pathDataForNode(node) {
/*
d="m 58,2  c -75,0 -75,100 0,100  l 60,0  l 50,-50  l -50,-50  Z"
d="m 58,2  c -75,0 -75,100 0,100  l 100,0  l 0,-100 Z"
d="m 2,0 l 0,100 l 100,0  l 50,-50  l -50,-50  Z"
*/
  switch (node.type) {
    case 'observer':
      return 'M -25,-50  c -75,0 -75,100 0,100  l 100,0  l 0,-100 Z';
    case 'observable':
      return 'M -25,-50  c -75,0 -75,100 0,100  l 60,0  l 50,-50  l -50,-50  Z';
    case 'value':
      return 'M -50,-50 l 0,100 l 100,0  l 50,-50  l -50,-50  Z';
  }
}

function getSourceCoords(node) {
  switch (node.type) {
    case 'observer':
    case 'observable':
      return {x: node.x - 5, y: node.y};
    default:
      return {x: node.x, y: node.y};
  }
}

function getTargetCoords(node) {
  switch (node.type) {
    case 'observable':
    case 'value':
      return {x: node.x + 8, y: node.y};
    default:
      return {x: node.x, y: node.y};
  }
}

function multilineTextNode(node) {
  var MAX_LINES = 6;
  var fade = false;
  var el = d3.select(this);
  var lines = el.text().split('\n');
  if (lines.length > MAX_LINES) {
    lines.splice(MAX_LINES);
    fade = true;
  }
  el.text('');
  el.selectAll('tspan').data(lines)
    .enter().append('tspan')
      .attr('x', 0)
      .attr('dy', function(line, i) { return i > 0 ? '1em' : 0})
      .attr('opacity', function(line, i) {
        if (!fade)
          return 1;
        return Math.min(1, (MAX_LINES - i) * 0.25 - 0.15);
      })
      .text(function(line) { return line; });
}

function update() {
  force.size([document.documentElement.clientWidth / 4,
              document.documentElement.clientHeight / 4]);

  var layoutDirty = true;

  node = d3.select('#nodes').selectAll('.node').data(nodeList);
  //layoutDirty = layoutDirty || !node.enter().empty() || !node.exit().empty();
  var newG = node.enter().append('g')
      .attr('class', function(n) {return 'node ' + n.type;})
      .attr('r', 5)
      .on('mousedown', function() {
        d3.event.stopPropagation();
      })
      .on('mouseover', function(n) {
        $('#description').text(n.title);
      })
      .on('mouseout', function(d, i) {
        $('#description').html('');
      })
      .call(force.drag);
  newG.append('path')
      .attr('transform', 'scale(0.08)')
      .attr('stroke', 'black')
      .attr('stroke-width', 4)
      .attr('fill', 'white')
      .attr('d', pathDataForNode);
  newG.append('text')
      .attr('x', 3)
      .attr('y', 0)
      .attr('font-size', 2.5)
      .text(function(n) {return n.label;})
      .each(multilineTextNode);
  node.exit().remove();
  node
      .classed('invalidated', function(n) { return n.invalidated; })
      .classed('running', function(n) { return n.running; })
      .attr('fill', function(n) {
        if (n.invalidated)
          return "url(#diagonalHatch)";
        else
          return null;
      });

  link = d3.select('#links').selectAll('.link').data(links);
  //layoutDirty = layoutDirty || !link.enter().empty() || !link.exit().empty();
  link.enter().append('path')
      .attr('class', 'link')
      .attr('marker-mid', 'url(#triangle)');
  link.exit().remove();

  if (layoutDirty) {
    force.start();
    layoutDirty = false;
  }
}

function onTick() {
  node
      .attr('transform', function(n) {
        return 'translate(' + n.x + ' ' + n.y + ')';
      });
  link
      .attr('d', function(link) {
        var source = getSourceCoords(link.source);
        var target = getTargetCoords(link.target)
        var mid = {
          x: (source.x + target.x) / 2,
          y: (source.y + target.y) / 2
        }
        return 'M' + source.x + ',' + source.y +
          ' L' + mid.x + ',' + mid.y +
          ' L' + target.x + ',' + target.y;
      });
}

function createNode(data, type) {
  var node;
  if (!data.prevId) {
    node = {
      label: data.label,
      type: data.type,
      index: nodeList.length
    };
    nodes[data.id] = node;
    nodeList.push(node);
  } else {
    node = nodes[data.prevId];
    delete nodes[data.prevId];
    nodes[data.id] = node;
    node.invalidated = false;
  }
}

var callbacks = {
  ctx: function(data) {
    createNode(data);
    return true;
  },
  dep: function(data) {
    if (!nodes[data.dependsOn])
      createNode({id: data.dependsOn, label: data.dependsOn, type: 'value'});
    links.push({
      source: nodes[data.id],
      target: nodes[data.dependsOn]
    });
  },
  depId: function(data) {
    links.push({
      source: nodes[data.id],
      target: nodes[data.dependsOn]
    });
  },
  invalidate: function(data) {
    var node = nodes[data.id];
    node.invalidated = true;
    links = links.filter(function(link) {
      return link.source !== node;
    });
  },
  valueChange: function(data) {
    var node = nodes[data.id];
    if (!node)
      return true;

  },
  enter: function(data) {
    var node = nodes[data.id];
    node.running = true;
  },
  exit: function(data) {
    var node = nodes[data.id];
    node.running = false;
  }
};

function processMessage(data) {
  console.log(JSON.stringify(data));
  if (!callbacks.hasOwnProperty(data.action))
    throw new Error('Unknown action ' + data.action);
  var result = callbacks[data.action].call(callbacks, data);
  update();
  return result;
}

function doNext() {
  while (log.length)
    if (!processMessage(log.shift()))
      break;
  if (log.length === 0)
    document.getElementById('processNext').setAttribute('disabled', 'disabled');
}

function zoom() {
  var scale = d3.event.scale;
  var x = d3.event.translate[0];
  var y = d3.event.translate[1];
  d3.select('#viz').attr('transform', 'scale(' + scale + ') translate(' + x/scale + ' ' + y/scale + ')');
}
$(function() {
  d3.select('svg').call(d3.behavior.zoom().scale(4).on('zoom', zoom));
});
</script>
<body>
  <button id="processNext" onclick="doNext();">Next</button>
  <br/>
  <svg>
    <defs>
      <marker id="triangle"
              viewBox="0 0 10 10" 
              refX="5" refY="5"
              markerWidth="6" 
              markerHeight="6"
              orient="auto">
          <path d="M 10 0 L 0 5 L 10 10 z" />
      </marker>
      <pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="1" height="1">
        <path stroke="black" stroke-width="0.25" fill="none"
          d="M-1,1 l2,-2
             M0,4 l4,-4
             M3,5 l2,-2" />
      </pattern>
    </defs>
    <g id="viz" transform="scale(4)">
      <g id="links"></g>
      <g id="nodes"></g>
    </g>
  </svg>
  <pre id="description"><br/></pre>
</body>
</html>
