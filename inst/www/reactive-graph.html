<!DOCTYPE html>
<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style type="text/css">
svg {
  border: 1px solid silver;
}
svg, #viz {
  width: 600px;
  height: 600px;
}
.node {
  z-index: 1;
  stroke: white;
  stroke-width: 1px;
  fill: #FEF2A9;
}
.node.observer {
  fill: #9C6E46;
}
.node.observable {
  fill: #C7D4E3;
}
.node.value {
  fill: #D0D0CD;
}

.node.invalidated {
  stroke: #FF2B3D;
}
.node.running {
  stroke: #333;
}
#triangle {
  fill: #CCC;
}
.link {
  fill: none;
  stroke: #CCC;
  stroke-width: 0.5px;
  z-index: 0;
}
#description {
  position: fixed;
  width: 300px;
  left: 630px;
  top: 36px;
  height: auto;
}
</style>
<script>
var log = [



  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$addMarkerOnClick"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$randomLocation"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$clearMarkers"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$year"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$maxCities"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeries_width"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeries_height"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_map_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_desc_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_data_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeriesLabel_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeries_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_markers_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$pixelratio"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_protocol"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_hostname"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_port"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_pathname"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_search"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$url_hash_initial"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$allowDataUriScheme"
  },
  {
    "action" : "valueChange",
    "id" : "names(reactiveValues3133.90144994506)"
  },
  {
    "action" : "valueChange",
    "id" : "reactiveValues3133.90144994506 (all)"
  },
  {
    "action" : "valueChange",
    "id" : "reactiveValues3133.90144994506$markers"
  },
  {
    "action" : "ctx",
    "id" : "1",
    "label" : "output$map",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "1"
  },
  {
    "action" : "ctx",
    "id" : "2",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "2"
  },
  {
    "action" : "ctx",
    "id" : "3",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "3"
  },
  {
    "action" : "ctx",
    "id" : "4",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "4"
  },
  {
    "action" : "ctx",
    "id" : "5",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "5"
  },
  {
    "action" : "ctx",
    "id" : "6",
    "label" : "{\n    map$clearShapes()\n    cities <- topCitiesInBounds()\n    if (nrow(cities) == 0) \n        return()\n    map$addCircle(cities$Lat, cities$Long, sqrt(cities[[popCol()]]) * \n        radiusFactor/max(5, input$map_zoom)^2, row.names(cities), \n        list(weight = 1.2, fill = TRUE, color = \"#4A9\"))\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "6"
  },
  {
    "action" : "ctx",
    "id" : "7",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "7"
  },
  {
    "action" : "ctx",
    "id" : "8",
    "label" : "output$desc",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "8"
  },
  {
    "action" : "ctx",
    "id" : "9",
    "label" : "output$data",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "9"
  },
  {
    "action" : "ctx",
    "id" : "10",
    "label" : "output$markers",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "10"
  },
  {
    "action" : "ctx",
    "id" : "11",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "11"
  },
  {
    "action" : "ctx",
    "id" : "12",
    "label" : "output$cityTimeSeriesLabel",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "12"
  },
  {
    "action" : "ctx",
    "id" : "13",
    "label" : "output$cityTimeSeries",
    "type" : "observer",
    "prevId" : ""
  },
  {
    "action" : "invalidate",
    "id" : "13"
  },
  {
    "action" : "ctx",
    "id" : "14",
    "label" : "output$map",
    "type" : "observer",
    "prevId" : "1"
  },
  {
    "action" : "enter",
    "id" : "14"
  },
  {
    "action" : "exit",
    "id" : "14"
  },
  {
    "action" : "ctx",
    "id" : "15",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "2"
  },
  {
    "action" : "enter",
    "id" : "15"
  },
  {
    "action" : "dep",
    "id" : "15",
    "dependsOn" : "input$addMarker"
  },
  {
    "action" : "exit",
    "id" : "15"
  },
  {
    "action" : "ctx",
    "id" : "16",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "3"
  },
  {
    "action" : "enter",
    "id" : "16"
  },
  {
    "action" : "dep",
    "id" : "16",
    "dependsOn" : "input$map_click"
  },
  {
    "action" : "exit",
    "id" : "16"
  },
  {
    "action" : "ctx",
    "id" : "17",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "4"
  },
  {
    "action" : "enter",
    "id" : "17"
  },
  {
    "action" : "dep",
    "id" : "17",
    "dependsOn" : "input$map_marker_click"
  },
  {
    "action" : "exit",
    "id" : "17"
  },
  {
    "action" : "ctx",
    "id" : "18",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "5"
  },
  {
    "action" : "enter",
    "id" : "18"
  },
  {
    "action" : "dep",
    "id" : "18",
    "dependsOn" : "input$clearMarkers"
  },
  {
    "action" : "exit",
    "id" : "18"
  },
  {
    "action" : "ctx",
    "id" : "19",
    "label" : "{\n    map$clearShapes()\n    cities <- topCitiesInBounds()\n    if (nrow(cities) == 0) \n        return()\n    map$addCircle(cities$Lat, cities$Long, sqrt(cities[[popCol()]]) * \n        radiusFactor/max(5, input$map_zoom)^2, row.names(cities), \n        list(weight = 1.2, fill = TRUE, color = \"#4A9\"))\n}",
    "type" : "observer",
    "prevId" : "6"
  },
  {
    "action" : "enter",
    "id" : "19"
  },
  {
    "action" : "ctx",
    "id" : "20",
    "label" : "{\n    cities <- citiesInBounds()\n    cities <- head(cities[order(cities[[popCol()]], decreasing = TRUE), \n        ], as.numeric(input$maxCities))\n}",
    "type" : "observable",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "20"
  },
  {
    "action" : "ctx",
    "id" : "21",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(uspop2000[FALSE, ])\n    bounds <- input$map_bounds\n    latRng <- range(bounds$north, bounds$south)\n    lngRng <- range(bounds$east, bounds$west)\n    subset(uspop2000, Lat >= latRng[1] & Lat <= latRng[2] & Long >= \n        lngRng[1] & Long <= lngRng[2])\n}",
    "type" : "observable",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "21"
  },
  {
    "action" : "dep",
    "id" : "21",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "exit",
    "id" : "21"
  },
  {
    "action" : "depId",
    "id" : "20",
    "dependsOn" : "21"
  },
  {
    "action" : "ctx",
    "id" : "22",
    "label" : "{\n    paste(\"Pop\", input$year, sep = \"\")\n}",
    "type" : "observable",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "22"
  },
  {
    "action" : "dep",
    "id" : "22",
    "dependsOn" : "input$year"
  },
  {
    "action" : "exit",
    "id" : "22"
  },
  {
    "action" : "depId",
    "id" : "20",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "20",
    "dependsOn" : "input$maxCities"
  },
  {
    "action" : "exit",
    "id" : "20"
  },
  {
    "action" : "depId",
    "id" : "19",
    "dependsOn" : "20"
  },
  {
    "action" : "exit",
    "id" : "19"
  },
  {
    "action" : "ctx",
    "id" : "23",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "7"
  },
  {
    "action" : "enter",
    "id" : "23"
  },
  {
    "action" : "dep",
    "id" : "23",
    "dependsOn" : "input$map_shape_click"
  },
  {
    "action" : "exit",
    "id" : "23"
  },
  {
    "action" : "ctx",
    "id" : "24",
    "label" : "output$desc",
    "type" : "observer",
    "prevId" : "8"
  },
  {
    "action" : "enter",
    "id" : "24"
  },
  {
    "action" : "ctx",
    "id" : "25",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(list())\n    list(lat = mean(c(input$map_bounds$north, input$map_bounds$south)), \n        lng = mean(c(input$map_bounds$east, input$map_bounds$west)), \n        zoom = input$map_zoom, shownCities = nrow(topCitiesInBounds()), \n        totalCities = nrow(citiesInBounds()))\n}",
    "type" : "observable",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "25"
  },
  {
    "action" : "dep",
    "id" : "25",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "exit",
    "id" : "25"
  },
  {
    "action" : "depId",
    "id" : "24",
    "dependsOn" : "25"
  },
  {
    "action" : "exit",
    "id" : "24"
  },
  {
    "action" : "ctx",
    "id" : "26",
    "label" : "output$data",
    "type" : "observer",
    "prevId" : "9"
  },
  {
    "action" : "enter",
    "id" : "26"
  },
  {
    "action" : "depId",
    "id" : "26",
    "dependsOn" : "20"
  },
  {
    "action" : "exit",
    "id" : "26"
  },
  {
    "action" : "ctx",
    "id" : "27",
    "label" : "output$markers",
    "type" : "observer",
    "prevId" : "10"
  },
  {
    "action" : "enter",
    "id" : "27"
  },
  {
    "action" : "dep",
    "id" : "27",
    "dependsOn" : "reactiveValues3133.90144994506$markers"
  },
  {
    "action" : "exit",
    "id" : "27"
  },
  {
    "action" : "ctx",
    "id" : "28",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "11"
  },
  {
    "action" : "enter",
    "id" : "28"
  },
  {
    "action" : "dep",
    "id" : "28",
    "dependsOn" : "input$randomLocation"
  },
  {
    "action" : "exit",
    "id" : "28"
  },
  {
    "action" : "ctx",
    "id" : "29",
    "label" : "output$cityTimeSeriesLabel",
    "type" : "observer",
    "prevId" : "12"
  },
  {
    "action" : "enter",
    "id" : "29"
  },
  {
    "action" : "dep",
    "id" : "29",
    "dependsOn" : "reactiveValues3133.90144994506$selectedCity"
  },
  {
    "action" : "exit",
    "id" : "29"
  },
  {
    "action" : "ctx",
    "id" : "30",
    "label" : "output$cityTimeSeries",
    "type" : "observer",
    "prevId" : "13"
  },
  {
    "action" : "enter",
    "id" : "30"
  },
  {
    "action" : "dep",
    "id" : "30",
    "dependsOn" : "clientData$output_cityTimeSeries_width"
  },
  {
    "action" : "dep",
    "id" : "30",
    "dependsOn" : "clientData$output_cityTimeSeries_height"
  },
  {
    "action" : "dep",
    "id" : "30",
    "dependsOn" : "clientData$pixelratio"
  },
  {
    "action" : "dep",
    "id" : "30",
    "dependsOn" : "reactiveValues3133.90144994506$selectedCity"
  },
  {
    "action" : "depId",
    "id" : "30",
    "dependsOn" : "20"
  },
  {
    "action" : "exit",
    "id" : "30"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeriesLabel_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeries_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_bounds"
  },
  {
    "action" : "invalidate",
    "id" : "21"
  },
  {
    "action" : "invalidate",
    "id" : "20"
  },
  {
    "action" : "invalidate",
    "id" : "19"
  },
  {
    "action" : "invalidate",
    "id" : "26"
  },
  {
    "action" : "invalidate",
    "id" : "30"
  },
  {
    "action" : "invalidate",
    "id" : "25"
  },
  {
    "action" : "invalidate",
    "id" : "24"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_zoom"
  },
  {
    "action" : "ctx",
    "id" : "31",
    "label" : "{\n    map$clearShapes()\n    cities <- topCitiesInBounds()\n    if (nrow(cities) == 0) \n        return()\n    map$addCircle(cities$Lat, cities$Long, sqrt(cities[[popCol()]]) * \n        radiusFactor/max(5, input$map_zoom)^2, row.names(cities), \n        list(weight = 1.2, fill = TRUE, color = \"#4A9\"))\n}",
    "type" : "observer",
    "prevId" : "19"
  },
  {
    "action" : "enter",
    "id" : "31"
  },
  {
    "action" : "ctx",
    "id" : "32",
    "label" : "{\n    cities <- citiesInBounds()\n    cities <- head(cities[order(cities[[popCol()]], decreasing = TRUE), \n        ], as.numeric(input$maxCities))\n}",
    "type" : "observable",
    "prevId" : "20"
  },
  {
    "action" : "enter",
    "id" : "32"
  },
  {
    "action" : "ctx",
    "id" : "33",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(uspop2000[FALSE, ])\n    bounds <- input$map_bounds\n    latRng <- range(bounds$north, bounds$south)\n    lngRng <- range(bounds$east, bounds$west)\n    subset(uspop2000, Lat >= latRng[1] & Lat <= latRng[2] & Long >= \n        lngRng[1] & Long <= lngRng[2])\n}",
    "type" : "observable",
    "prevId" : "21"
  },
  {
    "action" : "enter",
    "id" : "33"
  },
  {
    "action" : "dep",
    "id" : "33",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "exit",
    "id" : "33"
  },
  {
    "action" : "depId",
    "id" : "32",
    "dependsOn" : "33"
  },
  {
    "action" : "depId",
    "id" : "32",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "32",
    "dependsOn" : "input$maxCities"
  },
  {
    "action" : "exit",
    "id" : "32"
  },
  {
    "action" : "depId",
    "id" : "31",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "31",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "31",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "exit",
    "id" : "31"
  },
  {
    "action" : "ctx",
    "id" : "34",
    "label" : "output$data",
    "type" : "observer",
    "prevId" : "26"
  },
  {
    "action" : "enter",
    "id" : "34"
  },
  {
    "action" : "depId",
    "id" : "34",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "34",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "34",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "34",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "34",
    "dependsOn" : "22"
  },
  {
    "action" : "exit",
    "id" : "34"
  },
  {
    "action" : "ctx",
    "id" : "35",
    "label" : "output$cityTimeSeries",
    "type" : "observer",
    "prevId" : "30"
  },
  {
    "action" : "enter",
    "id" : "35"
  },
  {
    "action" : "dep",
    "id" : "35",
    "dependsOn" : "clientData$output_cityTimeSeries_width"
  },
  {
    "action" : "dep",
    "id" : "35",
    "dependsOn" : "clientData$output_cityTimeSeries_height"
  },
  {
    "action" : "dep",
    "id" : "35",
    "dependsOn" : "clientData$pixelratio"
  },
  {
    "action" : "dep",
    "id" : "35",
    "dependsOn" : "reactiveValues3133.90144994506$selectedCity"
  },
  {
    "action" : "depId",
    "id" : "35",
    "dependsOn" : "32"
  },
  {
    "action" : "exit",
    "id" : "35"
  },
  {
    "action" : "ctx",
    "id" : "36",
    "label" : "output$desc",
    "type" : "observer",
    "prevId" : "24"
  },
  {
    "action" : "enter",
    "id" : "36"
  },
  {
    "action" : "ctx",
    "id" : "37",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(list())\n    list(lat = mean(c(input$map_bounds$north, input$map_bounds$south)), \n        lng = mean(c(input$map_bounds$east, input$map_bounds$west)), \n        zoom = input$map_zoom, shownCities = nrow(topCitiesInBounds()), \n        totalCities = nrow(citiesInBounds()))\n}",
    "type" : "observable",
    "prevId" : "25"
  },
  {
    "action" : "enter",
    "id" : "37"
  },
  {
    "action" : "dep",
    "id" : "37",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "dep",
    "id" : "37",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "depId",
    "id" : "37",
    "dependsOn" : "32"
  },
  {
    "action" : "depId",
    "id" : "37",
    "dependsOn" : "33"
  },
  {
    "action" : "exit",
    "id" : "37"
  },
  {
    "action" : "depId",
    "id" : "36",
    "dependsOn" : "37"
  },
  {
    "action" : "exit",
    "id" : "36"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeriesLabel_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(clientData)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData (all)"
  },
  {
    "action" : "valueChange",
    "id" : "clientData$output_cityTimeSeries_hidden"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$randomLocation"
  },
  {
    "action" : "invalidate",
    "id" : "28"
  },
  {
    "action" : "ctx",
    "id" : "38",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "28"
  },
  {
    "action" : "enter",
    "id" : "38"
  },
  {
    "action" : "dep",
    "id" : "38",
    "dependsOn" : "input$randomLocation"
  },
  {
    "action" : "ctx",
    "id" : "39",
    "label" : "[isolate]",
    "type" : "isolate",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "39"
  },
  {
    "action" : "exit",
    "id" : "39"
  },
  {
    "action" : "invalidate",
    "id" : "39"
  },
  {
    "action" : "exit",
    "id" : "38"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_bounds"
  },
  {
    "action" : "invalidate",
    "id" : "33"
  },
  {
    "action" : "invalidate",
    "id" : "32"
  },
  {
    "action" : "invalidate",
    "id" : "31"
  },
  {
    "action" : "invalidate",
    "id" : "34"
  },
  {
    "action" : "invalidate",
    "id" : "35"
  },
  {
    "action" : "invalidate",
    "id" : "37"
  },
  {
    "action" : "invalidate",
    "id" : "36"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_zoom"
  },
  {
    "action" : "ctx",
    "id" : "40",
    "label" : "{\n    map$clearShapes()\n    cities <- topCitiesInBounds()\n    if (nrow(cities) == 0) \n        return()\n    map$addCircle(cities$Lat, cities$Long, sqrt(cities[[popCol()]]) * \n        radiusFactor/max(5, input$map_zoom)^2, row.names(cities), \n        list(weight = 1.2, fill = TRUE, color = \"#4A9\"))\n}",
    "type" : "observer",
    "prevId" : "31"
  },
  {
    "action" : "enter",
    "id" : "40"
  },
  {
    "action" : "ctx",
    "id" : "41",
    "label" : "{\n    cities <- citiesInBounds()\n    cities <- head(cities[order(cities[[popCol()]], decreasing = TRUE), \n        ], as.numeric(input$maxCities))\n}",
    "type" : "observable",
    "prevId" : "32"
  },
  {
    "action" : "enter",
    "id" : "41"
  },
  {
    "action" : "ctx",
    "id" : "42",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(uspop2000[FALSE, ])\n    bounds <- input$map_bounds\n    latRng <- range(bounds$north, bounds$south)\n    lngRng <- range(bounds$east, bounds$west)\n    subset(uspop2000, Lat >= latRng[1] & Lat <= latRng[2] & Long >= \n        lngRng[1] & Long <= lngRng[2])\n}",
    "type" : "observable",
    "prevId" : "33"
  },
  {
    "action" : "enter",
    "id" : "42"
  },
  {
    "action" : "dep",
    "id" : "42",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "exit",
    "id" : "42"
  },
  {
    "action" : "depId",
    "id" : "41",
    "dependsOn" : "42"
  },
  {
    "action" : "depId",
    "id" : "41",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "41",
    "dependsOn" : "input$maxCities"
  },
  {
    "action" : "exit",
    "id" : "41"
  },
  {
    "action" : "depId",
    "id" : "40",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "40",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "40",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "exit",
    "id" : "40"
  },
  {
    "action" : "ctx",
    "id" : "43",
    "label" : "output$data",
    "type" : "observer",
    "prevId" : "34"
  },
  {
    "action" : "enter",
    "id" : "43"
  },
  {
    "action" : "depId",
    "id" : "43",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "43",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "43",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "43",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "43",
    "dependsOn" : "22"
  },
  {
    "action" : "exit",
    "id" : "43"
  },
  {
    "action" : "ctx",
    "id" : "44",
    "label" : "output$cityTimeSeries",
    "type" : "observer",
    "prevId" : "35"
  },
  {
    "action" : "enter",
    "id" : "44"
  },
  {
    "action" : "dep",
    "id" : "44",
    "dependsOn" : "clientData$output_cityTimeSeries_width"
  },
  {
    "action" : "dep",
    "id" : "44",
    "dependsOn" : "clientData$output_cityTimeSeries_height"
  },
  {
    "action" : "dep",
    "id" : "44",
    "dependsOn" : "clientData$pixelratio"
  },
  {
    "action" : "dep",
    "id" : "44",
    "dependsOn" : "reactiveValues3133.90144994506$selectedCity"
  },
  {
    "action" : "depId",
    "id" : "44",
    "dependsOn" : "41"
  },
  {
    "action" : "exit",
    "id" : "44"
  },
  {
    "action" : "ctx",
    "id" : "45",
    "label" : "output$desc",
    "type" : "observer",
    "prevId" : "36"
  },
  {
    "action" : "enter",
    "id" : "45"
  },
  {
    "action" : "ctx",
    "id" : "46",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(list())\n    list(lat = mean(c(input$map_bounds$north, input$map_bounds$south)), \n        lng = mean(c(input$map_bounds$east, input$map_bounds$west)), \n        zoom = input$map_zoom, shownCities = nrow(topCitiesInBounds()), \n        totalCities = nrow(citiesInBounds()))\n}",
    "type" : "observable",
    "prevId" : "37"
  },
  {
    "action" : "enter",
    "id" : "46"
  },
  {
    "action" : "dep",
    "id" : "46",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "dep",
    "id" : "46",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "depId",
    "id" : "46",
    "dependsOn" : "41"
  },
  {
    "action" : "depId",
    "id" : "46",
    "dependsOn" : "42"
  },
  {
    "action" : "exit",
    "id" : "46"
  },
  {
    "action" : "depId",
    "id" : "45",
    "dependsOn" : "46"
  },
  {
    "action" : "exit",
    "id" : "45"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$randomLocation"
  },
  {
    "action" : "invalidate",
    "id" : "38"
  },
  {
    "action" : "ctx",
    "id" : "47",
    "label" : "{\n    eventVal <- eventFunc()\n    if (!initialized) \n        initialized <<- TRUE\n    else isolate(callback())\n}",
    "type" : "observer",
    "prevId" : "38"
  },
  {
    "action" : "enter",
    "id" : "47"
  },
  {
    "action" : "dep",
    "id" : "47",
    "dependsOn" : "input$randomLocation"
  },
  {
    "action" : "ctx",
    "id" : "48",
    "label" : "[isolate]",
    "type" : "isolate",
    "prevId" : ""
  },
  {
    "action" : "enter",
    "id" : "48"
  },
  {
    "action" : "exit",
    "id" : "48"
  },
  {
    "action" : "invalidate",
    "id" : "48"
  },
  {
    "action" : "exit",
    "id" : "47"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_bounds"
  },
  {
    "action" : "invalidate",
    "id" : "42"
  },
  {
    "action" : "invalidate",
    "id" : "41"
  },
  {
    "action" : "invalidate",
    "id" : "40"
  },
  {
    "action" : "invalidate",
    "id" : "43"
  },
  {
    "action" : "invalidate",
    "id" : "44"
  },
  {
    "action" : "invalidate",
    "id" : "46"
  },
  {
    "action" : "invalidate",
    "id" : "45"
  },
  {
    "action" : "valueChange",
    "id" : "names(input)"
  },
  {
    "action" : "valueChange",
    "id" : "input (all)"
  },
  {
    "action" : "valueChange",
    "id" : "input$map_zoom"
  },
  {
    "action" : "ctx",
    "id" : "49",
    "label" : "{\n    map$clearShapes()\n    cities <- topCitiesInBounds()\n    if (nrow(cities) == 0) \n        return()\n    map$addCircle(cities$Lat, cities$Long, sqrt(cities[[popCol()]]) * \n        radiusFactor/max(5, input$map_zoom)^2, row.names(cities), \n        list(weight = 1.2, fill = TRUE, color = \"#4A9\"))\n}",
    "type" : "observer",
    "prevId" : "40"
  },
  {
    "action" : "enter",
    "id" : "49"
  },
  {
    "action" : "ctx",
    "id" : "50",
    "label" : "{\n    cities <- citiesInBounds()\n    cities <- head(cities[order(cities[[popCol()]], decreasing = TRUE), \n        ], as.numeric(input$maxCities))\n}",
    "type" : "observable",
    "prevId" : "41"
  },
  {
    "action" : "enter",
    "id" : "50"
  },
  {
    "action" : "ctx",
    "id" : "51",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(uspop2000[FALSE, ])\n    bounds <- input$map_bounds\n    latRng <- range(bounds$north, bounds$south)\n    lngRng <- range(bounds$east, bounds$west)\n    subset(uspop2000, Lat >= latRng[1] & Lat <= latRng[2] & Long >= \n        lngRng[1] & Long <= lngRng[2])\n}",
    "type" : "observable",
    "prevId" : "42"
  },
  {
    "action" : "enter",
    "id" : "51"
  },
  {
    "action" : "dep",
    "id" : "51",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "exit",
    "id" : "51"
  },
  {
    "action" : "depId",
    "id" : "50",
    "dependsOn" : "51"
  },
  {
    "action" : "depId",
    "id" : "50",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "50",
    "dependsOn" : "input$maxCities"
  },
  {
    "action" : "exit",
    "id" : "50"
  },
  {
    "action" : "depId",
    "id" : "49",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "49",
    "dependsOn" : "22"
  },
  {
    "action" : "dep",
    "id" : "49",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "exit",
    "id" : "49"
  },
  {
    "action" : "ctx",
    "id" : "52",
    "label" : "output$data",
    "type" : "observer",
    "prevId" : "43"
  },
  {
    "action" : "enter",
    "id" : "52"
  },
  {
    "action" : "depId",
    "id" : "52",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "52",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "52",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "52",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "52",
    "dependsOn" : "22"
  },
  {
    "action" : "exit",
    "id" : "52"
  },
  {
    "action" : "ctx",
    "id" : "53",
    "label" : "output$cityTimeSeries",
    "type" : "observer",
    "prevId" : "44"
  },
  {
    "action" : "enter",
    "id" : "53"
  },
  {
    "action" : "dep",
    "id" : "53",
    "dependsOn" : "clientData$output_cityTimeSeries_width"
  },
  {
    "action" : "dep",
    "id" : "53",
    "dependsOn" : "clientData$output_cityTimeSeries_height"
  },
  {
    "action" : "dep",
    "id" : "53",
    "dependsOn" : "clientData$pixelratio"
  },
  {
    "action" : "dep",
    "id" : "53",
    "dependsOn" : "reactiveValues3133.90144994506$selectedCity"
  },
  {
    "action" : "depId",
    "id" : "53",
    "dependsOn" : "50"
  },
  {
    "action" : "exit",
    "id" : "53"
  },
  {
    "action" : "ctx",
    "id" : "54",
    "label" : "output$desc",
    "type" : "observer",
    "prevId" : "45"
  },
  {
    "action" : "enter",
    "id" : "54"
  },
  {
    "action" : "ctx",
    "id" : "55",
    "label" : "{\n    if (is.null(input$map_bounds)) \n        return(list())\n    list(lat = mean(c(input$map_bounds$north, input$map_bounds$south)), \n        lng = mean(c(input$map_bounds$east, input$map_bounds$west)), \n        zoom = input$map_zoom, shownCities = nrow(topCitiesInBounds()), \n        totalCities = nrow(citiesInBounds()))\n}",
    "type" : "observable",
    "prevId" : "46"
  },
  {
    "action" : "enter",
    "id" : "55"
  },
  {
    "action" : "dep",
    "id" : "55",
    "dependsOn" : "input$map_bounds"
  },
  {
    "action" : "dep",
    "id" : "55",
    "dependsOn" : "input$map_zoom"
  },
  {
    "action" : "depId",
    "id" : "55",
    "dependsOn" : "50"
  },
  {
    "action" : "depId",
    "id" : "55",
    "dependsOn" : "51"
  },
  {
    "action" : "exit",
    "id" : "55"
  },
  {
    "action" : "depId",
    "id" : "54",
    "dependsOn" : "55"
  },
  {
    "action" : "exit",
    "id" : "54"
  }



];

var nodes = {};
var nodeList = [];
var nodeSelection = null;
var links = [];
var linkSelection = null;
var layoutDirty = true;

var force = d3.layout.force()
    .nodes(nodeList)
    .links(links)
    .size([150, 150]);
force.on('tick', onTick);

function update() {
  var viz = d3.select('#viz');
  viz.select('#nodes').selectAll('.node').data(nodeList)
    .enter().append('circle')
      .attr('class', function(n) {return 'node ' + n.type;})
      .attr('title', function(n) {return n.label;})
      .attr('r', 5)
      .attr('onmouseover', '$("#description").text(this.getAttribute("title"));')
      .attr('onmouseout', '$("#description").html("<br/>");')
      .call(force.drag);
  viz.selectAll('.node').data(nodeList)
    .exit().remove();
  nodeSelection = viz.selectAll('.node');
  nodeSelection.classed('invalidated', function(n) { return n.invalidated; })
  nodeSelection.classed('running', function(n) { return n.running; })

  viz.select('#links').selectAll('.link').data(links)
    .enter().append('path')
      .attr('class', 'link')
      .attr('marker-end', 'url(#triangle)');
  viz.selectAll('.link').data(links)
    .exit().remove();
  linkSelection = viz.selectAll('.link');

  if (layoutDirty) {
    force.start();
    layoutDirty = false;
  }
}

function onTick() {
  nodeSelection
      .attr('cx', function(n) { return n.x; })
      .attr('cy', function(n) { return n.y; })
  ;
  linkSelection
      .attr('d', function(link) {
        return 'M' + link.source.x + ',' + link.source.y +
          ' L' + link.target.x + ',' + link.target.y;
      });
}

function createNode(data, type) {
  var node;
  if (!data.prevId) {
    node = {
      label: data.label,
      type: data.type,
      index: nodeList.length
    };
    nodes[data.id] = node;
    nodeList.push(node);
    layoutDirty = true;
  } else {
    node = nodes[data.prevId];
    delete nodes[data.prevId];
    nodes[data.id] = node;
    node.invalidated = false;
  }
}

var callbacks = {
  ctx: function(data) {
    createNode(data);
    return true;
  },
  dep: function(data) {
    if (!nodes[data.dependsOn])
      createNode({id: data.dependsOn, label: data.dependsOn, type: 'value'});
    links.push({
      source: nodes[data.id],
      target: nodes[data.dependsOn]
    });
    layoutDirty = true;
  },
  depId: function(data) {
    links.push({
      source: nodes[data.id],
      target: nodes[data.dependsOn]
    });
    layoutDirty = true;
  },
  invalidate: function(data) {
    var node = nodes[data.id];
    node.invalidated = true;
    links = links.filter(function(link) {
      return link.source !== node;
    });
    layoutDirty = true;
  },
  valueChange: function(data) {
    return true;
  },
  enter: function(data) {
    var node = nodes[data.id];
    node.running = true;
  },
  exit: function(data) {
    var node = nodes[data.id];
    node.running = false;
  }
};

function processMessage(data) {
  console.log(JSON.stringify(data));
  if (!callbacks.hasOwnProperty(data.action))
    throw new Error('Unknown action ' + data.action);
  var result = callbacks[data.action].call(callbacks, data);
  update();
  return result;
}

function doNext() {
  while (log.length)
    if (!processMessage(log.shift()))
      break;
  if (log.length === 0)
    document.getElementById('processNext').setAttribute('disabled', 'disabled');
}

function zoom() {
  var scale = d3.event.scale;
  var x = d3.event.translate[0];
  var y = d3.event.translate[1];
  d3.select('#viz').attr('transform', 'scale(' + scale + ') translate(' + x/scale + ' ' + y/scale + ')');
}
$(function() {
  d3.select('svg').call(d3.behavior.zoom().scale(4).on('zoom', zoom));
});
</script>
<body>
  <button id="processNext" onclick="doNext();">Next</button>
  <br/>
  <div id="container">
    <svg>
      <defs>
        <marker id="triangle"
                viewBox="0 0 10 10" 
                refX="28" refY="5"
                markerWidth="6" 
                markerHeight="6"
                orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" />
        </marker>
      </defs>
      <g id="viz" transform="scale(4)">
        <g id="links"></g>
        <g id="nodes"></g>
      </g>
    </svg>
  </div>
  <pre id="description"><br/></pre>
</body>
</html>
<!--
<svg style="border: 1px solid silver; width: 400px; height: 400px">
  <g>
    <path stroke="black" stroke-width="4" fill="white" d="m 58,2  c -75,0 -75,100 0,100  l 60,0  l 50,-50  l -50,-50  Z"/>
  </g>
  <g transform="translate(0 110)">
      <path stroke="black" stroke-width="4" fill="white" d="m 58,2  c -75,0 -75,100 0,100  l 100,0  l 0,-100 Z"/>
  </g>
  <g transform="translate(0 220)">
    <path stroke="black" stroke-width="4" fill="white" d="m 2,0 l 0,100 l 100,0  l 50,-50  l -50,-50  Z"/>
  </g>
</svg>
-->